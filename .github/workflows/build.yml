name: Build OrangeFox Recovery for OnePlus Ace3 Pro (corvette)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build_recovery:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: write
      checks: write

    steps:
      - name: 1. 清理磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /var/cache/apt/archives/*
          sudo apt autoremove -y && sudo apt clean
          df -h

      - name: 2. 安装核心编译依赖
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
            git git-lfs gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils \
            lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev openjdk-11-jdk \
            python3 python3-pip

      - name: 3. 安装 Repo 工具（绝对路径调用）
        run: |
          mkdir -p /usr/local/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > /usr/local/bin/repo
          chmod a+rx /usr/local/bin/repo
          /usr/local/bin/repo --version

      - name: 4. 配置 Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git lfs install --force

      - name: 5. 使用官方同步脚本拉取 OrangeFox 12.1 源码
        run: |
          mkdir -p ~/OrangeFox && cd ~/OrangeFox
          git clone https://gitlab.com/OrangeFox/sync.git
          cd sync
          ./orangefox_sync.sh --branch 12.1 --path ~/OrangeFox/fox_12.1

      - name: 6. 克隆指定设备树（haotaer仓库）
        run: |
          cd ~/OrangeFox/fox_12.1
          # 克隆默认分支，避免指定不存在的main分支
          git clone https://github.com/haotaer/OnePlusAce3Pro-orangefox-Rec.git device/oneplus/corvette
          ls -l device/oneplus/corvette

      - name: 7. 开始编译 OrangeFox Recovery
        run: |
          cd ~/OrangeFox/fox_12.1
          source build/envsetup.sh
          lunch orangefox_corvette-eng
          make clean
          make recoveryimage -j4

      - name: 8. 上传编译产物
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: OrangeFox-corvette-${{ github.run_id }}
          path: |
            ~/OrangeFox/fox_12.1/out/target/product/corvette/recovery.img
            ~/OrangeFox/fox_12.1/out/target/product/corvette/OrangeFox*.img
          retention-days: 7
