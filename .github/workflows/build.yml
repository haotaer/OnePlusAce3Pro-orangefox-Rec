name: Build OrangeFox Recovery for OnePlus Ace3 Pro (corvette)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build_recovery:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: write
      checks: write

    steps:
      - name: 1. 清理磁盘空间（编译必备）
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /var/cache/apt/archives/*
          sudo apt autoremove -y && sudo apt clean
          df -h

      - name: 2. 安装核心编译依赖
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
            git git-lfs gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils \
            lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev openjdk-11-jdk \
            python3 python3-pip

      - name: 3. 安装 Repo 工具（绝对路径调用）
        run: |
          mkdir -p /usr/local/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > /usr/local/bin/repo
          chmod a+rx /usr/local/bin/repo
          /usr/local/bin/repo --version

      - name: 4. 配置 Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git lfs install --force

      - name: 5. 使用官方同步脚本拉取 OrangeFox 12.1 源码
        run: |
          mkdir -p ~/OrangeFox && cd ~/OrangeFox
          git clone https://gitlab.com/OrangeFox/sync.git
          cd sync
          ./orangefox_sync.sh --branch 12.1 --path ~/OrangeFox/fox_12.1

      - name: 6. 克隆设备树并修复配置（关键步骤）
        run: |
          cd ~/OrangeFox/fox_12.1
          # 克隆设备树
          git clone https://github.com/haotaer/OnePlusAce3Pro-orangefox-Rec.git device/oneplus/corvette
          # 修复1：重写 vendorsetup.sh，只保留最精简的环境变量，避免任何可能的语法或函数冲突
          cat > device/oneplus/corvette/vendorsetup.sh << 'EOF'
          #!/bin/bash
          # 定义橙狐编译变量
          export FOX_BUILD_DEVICE="corvette"
          export OF_FORCE_PREBUILT_KERNEL=1
          export ALLOW_MISSING_DEPENDENCIES=true
          EOF
          # 修复2：重写 AndroidProducts.mk，确保路径和 lunch 选项完全正确
          cat > device/oneplus/corvette/AndroidProducts.mk << 'EOF'
          # Copyright (C) 2024 The Android Open Source Project
          # SPDX-License-Identifier: Apache-2.0
          PRODUCT_MAKEFILES := \
              $(LOCAL_DIR)/twrp_corvette.mk
          COMMON_LUNCH_CHOICES := \
              orangefox_corvette-eng
          EOF
          # 修复3：给脚本加上执行权限
          chmod +x device/oneplus/corvette/vendorsetup.sh
          # 调试：打印文件内容，确认修复成功
          echo "=== vendorsetup.sh ==="
          cat device/oneplus/corvette/vendorsetup.sh
          echo "=== AndroidProducts.mk ==="
          cat device/oneplus/corvette/AndroidProducts.mk
          echo "=== 目录结构 ==="
          ls -la device/oneplus/corvette/

      - name: 7. 调试：手动执行 vendorsetup.sh 并打印详细错误
        run: |
          cd ~/OrangeFox/fox_12.1
          # 开启调试模式，打印执行过程
          set -x
          # 手动执行脚本，捕获详细错误
          source device/oneplus/corvette/vendorsetup.sh
          echo "FOX_BUILD_DEVICE: $FOX_BUILD_DEVICE"
          echo "OF_FORCE_PREBUILT_KERNEL: $OF_FORCE_PREBUILT_KERNEL"
          set +x

      - name: 8. 开始编译 OrangeFox Recovery
        run: |
          cd ~/OrangeFox/fox_12.1
          source build/envsetup.sh
          # 调试：打印所有可用的 lunch 选项
          echo "=== 可用 lunch 选项 ==="
          lunch
          # 选择 lunch 并编译
          lunch orangefox_corvette-eng
          make clean
          make recoveryimage -j4

      - name: 9. 上传编译产物
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: OrangeFox-corvette-${{ github.run_id }}
          path: |
            ~/OrangeFox/fox_12.1/out/target/product/corvette/recovery.img
            ~/OrangeFox/fox_12.1/out/target/product/corvette/OrangeFox*.img
          retention-days: 7
